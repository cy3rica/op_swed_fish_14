-- These queries set up data for end-of-year student performance data reporting.

-- QUERY SYNTAX (Merge in columns from RPT_STUDENT_MAIN and RPT_SCHOOL_GRADE -- STEP 1):

SELECT dbo.RPT_STUDENT_MAIN.SITE_NAME, dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, dbo.RPT_STUDENT_MAIN.GRADE_ID, dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, dbo.RPT_STUDENT_MAIN.STUDENT_ID, dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.ASSESSMENT_TYPE, prepost.PRE_VALUE, prepost.PRE_VALUE_DISPLAY, prepost.PRE_VALUE_NUM, prepost.PRE_DATE, prepost.PRE_DESC, prepost.PRE_TRACK, prepost.PRE_TRACK_EVAL, prepost.PRE_TRACK_NATIONAL, prepost.POST_VALUE, prepost.POST_VALUE_DISPLAY, prepost.POST_VALUE_NUM, prepost.POST_DATE, prepost.POST_DESC, prepost.POST_TRACK, prepost.POST_TRACK_EVAL, prepost.POST_TRACK_NATIONAL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.ENROLLED_DAYS_CATEGORIES, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.LIT_ASSESS_RAWCHANGE, prepost.LIT_ASSESS_RAWCHANGE_DEGREE, prepost.LIT_ASSESS_PERFORMANCECHANGE_LOCAL, prepost.LIT_ASSESS_PERFORMANCECHANGE_NORMALIZED, prepost.LIT_ASSESS_PERCENTCHANGE, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.TTL_TIME >= dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 1 WHEN prepost.TTL_TIME < dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 0 ELSE NULL END AS EOY_MET_Q3_DOSAGE
FROM dbo.RPT_SCHOOL_GRADE INNER JOIN (dbo.RPT_STUDENT_MAIN INNER JOIN dbo.EVAL_ASSESSMENT AS prepost
ON (dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 5)
WHERE dbo.RPT_SCHOOL_GRADE.GRADE_ID = dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS';

-- QUERY SYNTAX (Merge to pre/post literacy assessment data -- BASED ON ABOVE QUERY -- STEP 2 -- this extra step is required since calculations for new variables can't reference variables that were just created in the same query):

DROP TABLE ImpactAnalytics.dbo.FY14_EOY_MTH_ASSESS
SELECT MTH.*,
CASE WHEN ((SCHOOL_ID = 2848 Or SCHOOL_ID = 2988) And GRADE_ID_RECODE < 9) Or (SCHOOL_ID = 3010 And GRADE_ID_RECODE > 9) THEN '0' ELSE DIPLOMAS_NOW_SCHOOL END AS DN_SCHOOL_BY_GRADE,
CASE WHEN GRADE_ID_RECODE >= B_RULE_VAL3 AND GRADE_ID_RECODE <= B_RULE_VAL4 THEN 1 WHEN GRADE_ID_RECODE < B_RULE_VAL3 OR GRADE_ID_RECODE > B_RULE_VAL4 THEN 0 ELSE NULL END AS EOY_IN_IOG_GRADE_RANGE
INTO ImpactAnalytics.dbo.FY14_EOY_MTH_ASSESS
FROM
(*****ABOVE_QUERY*****)
AS MTH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;

-- QUERY SYNTAX (Merge to pre/post math assessment data -- SINGLE QUERY VERSION):

DROP TABLE ImpactAnalytics.dbo.FY14_EOY_MTH_ASSESS
SELECT MTH.*,
CASE WHEN ((SCHOOL_ID = 2848 Or SCHOOL_ID = 2988) And GRADE_ID_RECODE < 9) Or (SCHOOL_ID = 3010 And GRADE_ID_RECODE > 9) THEN '0' ELSE DIPLOMAS_NOW_SCHOOL END AS DN_SCHOOL_BY_GRADE,
CASE WHEN GRADE_ID_RECODE >= B_RULE_VAL3 AND GRADE_ID_RECODE <= B_RULE_VAL4 THEN 1 WHEN GRADE_ID_RECODE < B_RULE_VAL3 OR GRADE_ID_RECODE > B_RULE_VAL4 THEN 0 ELSE NULL END AS EOY_IN_IOG_GRADE_RANGE
INTO ImpactAnalytics.dbo.FY14_EOY_MTH_ASSESS
FROM
(SELECT dbo.RPT_STUDENT_MAIN.SITE_NAME, dbo.RPT_STUDENT_MAIN.SCHOOL_NAME, dbo.RPT_STUDENT_MAIN.GRADE_ID, dbo.RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, dbo.RPT_STUDENT_MAIN.STUDENT_ID, dbo.RPT_STUDENT_MAIN.SCHOOL_ID, prepost.ASSESSMENT_TYPE, prepost.PRE_VALUE, prepost.PRE_VALUE_DISPLAY, prepost.PRE_VALUE_NUM, prepost.PRE_DATE, prepost.PRE_DESC, prepost.PRE_TRACK, prepost.PRE_TRACK_EVAL, prepost.PRE_TRACK_NATIONAL, prepost.POST_VALUE, prepost.POST_VALUE_DISPLAY, prepost.POST_VALUE_NUM, prepost.POST_DATE, prepost.POST_DESC, prepost.POST_TRACK, prepost.POST_TRACK_EVAL, prepost.POST_TRACK_NATIONAL, prepost.DOSAGE_CATEGORY, prepost.TTL_TIME, prepost.ENROLLED_DAYS_CATEGORIES, prepost.CURRENTLY_ENROLLED, prepost.ENROLLED_DAYS, prepost.LIT_ASSESS_RAWCHANGE, prepost.LIT_ASSESS_RAWCHANGE_DEGREE, prepost.LIT_ASSESS_PERFORMANCECHANGE_LOCAL, prepost.LIT_ASSESS_PERFORMANCECHANGE_NORMALIZED, prepost.LIT_ASSESS_PERCENTCHANGE, prepost.STATUS_SITE_DOSAGE_GOAL, prepost.SITE_DOSAGE_GOAL, prepost.Attendance_IA, prepost.ELA_IA, prepost.Math_IA, prepost.Behavior_IA, dbo.RPT_SCHOOL_GRADE.INDICATOR_ID, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL1, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL3, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL4, dbo.RPT_SCHOOL_GRADE.B_RULE_VAL5,
CASE WHEN dbo.RPT_STUDENT_MAIN.GRADE_ID = 21 THEN -1 WHEN dbo.RPT_STUDENT_MAIN.GRADE_ID = 22 THEN 0 ELSE dbo.RPT_STUDENT_MAIN.GRADE_ID END AS GRADE_ID_RECODE,
CASE WHEN prepost.TTL_TIME >= dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 1 WHEN prepost.TTL_TIME < dbo.RPT_SCHOOL_GRADE.B_RULE_VAL2 THEN 0 ELSE NULL END AS EOY_MET_Q3_DOSAGE
FROM dbo.RPT_SCHOOL_GRADE INNER JOIN (dbo.RPT_STUDENT_MAIN INNER JOIN dbo.EVAL_ASSESSMENT AS prepost
ON (dbo.RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (dbo.RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND dbo.RPT_SCHOOL_GRADE.INDICATOR_ID = 5)
WHERE dbo.RPT_SCHOOL_GRADE.GRADE_ID = dbo.RPT_STUDENT_MAIN.GRADE_ID AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS')
AS MTH
ORDER BY SITE_NAME, SCHOOL_NAME, GRADE_ID, STUDENT_ID;