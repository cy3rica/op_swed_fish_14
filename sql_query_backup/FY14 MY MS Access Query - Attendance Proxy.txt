-- Create proxy ADA data points separately for monthly attendance, marking period-based attendance, and cumulative attendance. Then merge and select proxy data point.
-- Pulling in proxy based on null POST_ATT_ADA, not post tag. System won't calc DJFM for some students, while proxy may.

-- QUERY SYNTAX (MY proxy DJFM):

SELECT attDJFM.*, attConfig.*
FROM
(SELECT att.STUDENT_ID, SUM(att.MISSED_DAYS) AS sumMD, SUM(att.NOT_ENROLLED_DAYS) AS sumNED, SUM(att.SCHOOL_OPEN) AS sumSO,
IIf(COUNT(PERF_ADA) >= 2,(sumSO - sumNED - sumMD)/(sumSO - sumNED),NULL) AS MY_ADA,
AVG(att.CONFIG_ID) AS MY_CONFIG_ID
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att
WHERE (INTERVAL LIKE 'Dec' OR INTERVAL LIKE 'Jan' OR INTERVAL LIKE 'Feb' OR INTERVAL LIKE 'Mar') AND PERF_ADA IS NOT NULL AND PERF_ADA >= 0
GROUP BY STUDENT_ID)
AS attDJFM LEFT JOIN dbo_ATTENDANCE_CONFIG_BENCHMARKS AS attConfig
ON (attDJFM.MY_CONFIG_ID = attConfig.CONFIG_ID AND attDJFM.MY_ADA >= attConfig.MIN_VALUE AND attDJFM.MY_ADA <= attConfig.MAX_VALUE);

-- QUERY SYNTAX (MY proxy cumulative):

SELECT attCumul.*, attConfig.*
FROM
(SELECT att.STUDENT_ID, AVG(att.FREQUENCY_PERIOD_ID) AS avgFREQID, SUM(att.MISSED_DAYS) AS sumMD, SUM(att.NOT_ENROLLED_DAYS) AS sumNED, SUM(att.SCHOOL_OPEN) AS sumSO,
IIf((((avgFREQID >= 68 AND avgFREQID <= 69) OR (avgFREQID >= 35 AND avgFREQID <= 37)) AND COUNT(att.PERF_ADA) >= 1) OR ((avgFREQID >= 31 AND avgFREQID <= 34) AND COUNT(att.PERF_ADA) >= 2) OR ((avgFREQID >= 13 AND avgFREQID <= 18) AND COUNT(att.PERF_ADA) >= 3) OR ((avgFREQID >= 47 AND avgFREQID <= 57) AND COUNT(att.PERF_ADA) >= 6),(sumSO - sumNED - sumMD)/(sumSO - sumNED),Null) AS MY_ADA,
AVG(att.CONFIG_ID) AS MY_CONFIG_ID
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att
WHERE INTERVAL NOT LIKE 'Attendance PrYr' AND PERF_ADA IS NOT NULL AND PERF_ADA >= 0
GROUP BY STUDENT_ID)
AS attCumul LEFT JOIN dbo_ATTENDANCE_CONFIG_BENCHMARKS AS attConfig
ON (attCumul.MY_CONFIG_ID = attConfig.CONFIG_ID AND attCumul.MY_ADA >= attConfig.MIN_VALUE AND attCumul.MY_ADA <= attConfig.MAX_VALUE);

-- QUERY SYNTAX (MY proxy Marking Periods):

SELECT att1.*
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att1 LEFT JOIN dbo_RPT_PERFORMANCE_LEVEL_ATT AS att2 ON (att1.STUDENT_ID = att2.STUDENT_ID AND att1.FREQUENCY_PERIOD_ID < att2.FREQUENCY_PERIOD_ID AND att1.INTERVAL NOT LIKE '1st*' AND ISNULL(att1.Tag) AND (att1.INTERVAL LIKE '*Semester' OR att1.INTERVAL LIKE '*Trimester' OR att1.INTERVAL LIKE '*Quarter' OR att1.INTERVAL LIKE '*Marking Period') AND att1.PERF_ADA IS NOT NULL AND att1.PERF_ADA >= 0)
WHERE att2.STUDENT_ID IS NULL;

-- QUERY SYNTAX (Merge and concatenate - BASED ON ABOVE QUERIES):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON' AND MY_ADA IS NOT NULL),'DJFM',(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period') AND MY_ADA IS NOT NULL),[MY_PROXY_ATTMP].[INTERVAL],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr' AND MY_ADA IS NOT NULL),'Cumulative To-Date',IIf(MY_ADA IS NULL,NULL,[prepost].[POST_FREQ_DESC]))))) AS MY_FREQ_DESC,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON'),[MY_PROXY_ATTDJFM].[MY_ADA],(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period')),[MY_PROXY_ATTMP].[PERF_ADA],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr'),[MY_PROXY_ATTCUMUL].[MY_ADA],[prepost].[POST_ATT_ADA])))) AS MY_ADA,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON'),[MY_PROXY_ATTDJFM].[SCALE],(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period')),[MY_PROXY_ATTMP].[SCALE_LOCAL],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr'),[MY_PROXY_ATTCUMUL].[SCALE],[prepost].[POST_ATT_TRACK])))) AS MY_TRACK,
IIf(MY_ADA IS NOT NULL AND prepost.PRE_ATT_ADA IS NOT NULL, MY_ADA - prepost.PRE_ATT_ADA,NULL) AS MY_ADA_CHANGE,
IIf((prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE >= 0.01),'Increase by at least 1 percentage point',IIf((prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE <= -0.01),'Decrease by at least 1 percentage point',IIf(prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE < 0.01 AND MY_ADA_CHANGE > -0.01,'No change',NULL))) AS MY_ATT_ADA_CHANGE_TYPE,
IIf((prepost.PRE_ATT_ADA <= 0.98 AND MY_ADA_CHANGE >= 0.02),1,IIf((prepost.PRE_ATT_ADA <= 0.98 AND MY_ADA_CHANGE < 0.02),0,NULL)) AS MY_ATT_INC_BY_2_PERC_PT,
IIf(prepost.PRE_ATT_TRACK IS NOT NULL AND MY_TRACK IS NOT NULL,prepost.PRE_ATT_TRACK & ' to ' & MY_TRACK,'Insufficient Data') AS MY_ATT_PERFORMANCE_CHANGE_LOCAL,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.ENROLLED_DAYS >= 56,1,IIf(prepost.ENROLLED_DAYS < 56,0,NULL)) AS MY_MET_56_DAYS,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE,
IIf(prepost.PRE_ATT_ADA < 0.9 AND MY_ADA >= 0.9,1,IIf(prepost.PRE_ATT_ADA < 0.9 AND MY_ADA < 0.9,0,NULL)) AS IOG_LT_90_TO_GTE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (((dbo_EVAL_ATT AS prepost LEFT JOIN
(*****ABOVE_QUERY_MarkingPeriod*****)
AS MY_PROXY_ATTMP ON (prepost.STUDENT_ID = MY_PROXY_ATTMP.STUDENT_ID))
LEFT JOIN
(*****ABOVE_QUERY_DJFM*****)
AS MY_PROXY_ATTDJFM ON (prepost.STUDENT_ID = MY_PROXY_ATTDJFM.STUDENT_ID))
LEFT JOIN
(*****ABOVE_QUERY_CUMULATIVE*****)
AS MY_PROXY_ATTCUMUL ON (prepost.STUDENT_ID = MY_PROXY_ATTCUMUL.STUDENT_ID))
ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = dbo_RPT_STUDENT_MAIN.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 1) WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;

-- QUERY SYNTAX (Merge and concatenate - SINGLE QUERY VERSION -- DOUBLE CHECK THIS QUERY WHEN MORE DATA IS SUBMITTED FOR CUMULATIVE DATA):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON' AND MY_ADA IS NOT NULL),'DJFM',(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period') AND MY_ADA IS NOT NULL),[MY_PROXY_ATTMP].[INTERVAL],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr' AND MY_ADA IS NOT NULL),'Cumulative To-Date',IIf(MY_ADA IS NULL,NULL,[prepost].[POST_FREQ_DESC]))))) AS MY_FREQ_DESC,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON'),[MY_PROXY_ATTDJFM].[MY_ADA],(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period')),[MY_PROXY_ATTMP].[PERF_ADA],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr'),[MY_PROXY_ATTCUMUL].[MY_ADA],[prepost].[POST_ATT_ADA])))) AS MY_ADA,
IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'ASON'),[MY_PROXY_ATTDJFM].[SCALE],(IIf(([prepost].[POST_ATT_ADA] IS NULL AND ([prepost].[PRE_FREQ_DESC] LIKE '*Semester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Trimester' OR [prepost].[PRE_FREQ_DESC] LIKE '*Quarter' OR [prepost].[PRE_FREQ_DESC] LIKE '*Marking Period')),[MY_PROXY_ATTMP].[SCALE_LOCAL],IIf(([prepost].[POST_ATT_ADA] IS NULL AND [prepost].[PRE_FREQ_DESC] LIKE 'Attendance PrYr'),[MY_PROXY_ATTCUMUL].[SCALE],[prepost].[POST_ATT_TRACK])))) AS MY_TRACK,
IIf(MY_ADA IS NOT NULL AND prepost.PRE_ATT_ADA IS NOT NULL, MY_ADA - prepost.PRE_ATT_ADA,NULL) AS MY_ADA_CHANGE,
IIf((prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE >= 0.01),'Increase by at least 1 percentage point',IIf((prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE <= -0.01),'Decrease by at least 1 percentage point',IIf(prepost.PRE_ATT_ADA <= 0.99 AND MY_ADA_CHANGE < 0.01 AND MY_ADA_CHANGE > -0.01,'No change',NULL))) AS MY_ATT_ADA_CHANGE_TYPE,
IIf((prepost.PRE_ATT_ADA <= 0.98 AND MY_ADA_CHANGE >= 0.02),1,IIf((prepost.PRE_ATT_ADA <= 0.98 AND MY_ADA_CHANGE < 0.02),0,NULL)) AS MY_ATT_INC_BY_2_PERC_PT,
IIf(prepost.PRE_ATT_TRACK IS NOT NULL AND MY_TRACK IS NOT NULL,prepost.PRE_ATT_TRACK & ' to ' & MY_TRACK,'Insufficient Data') AS MY_ATT_PERFORMANCE_CHANGE_LOCAL,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.ENROLLED_DAYS >= 56,1,IIf(prepost.ENROLLED_DAYS < 56,0,NULL)) AS MY_MET_56_DAYS,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE,
IIf(prepost.PRE_ATT_ADA < 0.9 AND MY_ADA >= 0.9,1,IIf(prepost.PRE_ATT_ADA < 0.9 AND MY_ADA < 0.9,0,NULL)) AS IOG_LT_90_TO_GTE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (((dbo_EVAL_ATT AS prepost LEFT JOIN
(SELECT att1.*
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att1 LEFT JOIN dbo_RPT_PERFORMANCE_LEVEL_ATT AS att2 ON (att1.STUDENT_ID = att2.STUDENT_ID AND att1.FREQUENCY_PERIOD_ID < att2.FREQUENCY_PERIOD_ID AND att1.INTERVAL NOT LIKE '1st*' AND ISNULL(att1.Tag) AND (att1.INTERVAL LIKE '*Semester' OR att1.INTERVAL LIKE '*Trimester' OR att1.INTERVAL LIKE '*Quarter' OR att1.INTERVAL LIKE '*Marking Period') AND att1.PERF_ADA IS NOT NULL AND att1.PERF_ADA >= 0)
WHERE att2.STUDENT_ID IS NULL)
AS MY_PROXY_ATTMP ON (prepost.STUDENT_ID = MY_PROXY_ATTMP.STUDENT_ID))
LEFT JOIN
(SELECT attDJFM.*, attConfig.*
FROM
(SELECT att.STUDENT_ID, SUM(att.MISSED_DAYS) AS sumMD, SUM(att.NOT_ENROLLED_DAYS) AS sumNED, SUM(att.SCHOOL_OPEN) AS sumSO,
IIf(COUNT(PERF_ADA) >= 2,(sumSO - sumNED - sumMD)/(sumSO - sumNED),NULL) AS MY_ADA,
AVG(att.CONFIG_ID) AS MY_CONFIG_ID
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att
WHERE (INTERVAL LIKE 'Dec' OR INTERVAL LIKE 'Jan' OR INTERVAL LIKE 'Feb' OR INTERVAL LIKE 'Mar') AND PERF_ADA IS NOT NULL AND PERF_ADA >= 0
GROUP BY STUDENT_ID)
AS attDJFM LEFT JOIN dbo_ATTENDANCE_CONFIG_BENCHMARKS AS attConfig
ON (attDJFM.MY_CONFIG_ID = attConfig.CONFIG_ID AND attDJFM.MY_ADA >= attConfig.MIN_VALUE AND attDJFM.MY_ADA <= attConfig.MAX_VALUE))
AS MY_PROXY_ATTDJFM ON (prepost.STUDENT_ID = MY_PROXY_ATTDJFM.STUDENT_ID))
LEFT JOIN
(SELECT attCumul.*, attConfig.*
FROM
(SELECT att.STUDENT_ID, AVG(att.FREQUENCY_PERIOD_ID) AS avgFREQID, SUM(att.MISSED_DAYS) AS sumMD, SUM(att.NOT_ENROLLED_DAYS) AS sumNED, SUM(att.SCHOOL_OPEN) AS sumSO,
IIf((((avgFREQID >= 68 AND avgFREQID <= 69) OR (avgFREQID >= 35 AND avgFREQID <= 37)) AND COUNT(att.PERF_ADA) >= 1) OR ((avgFREQID >= 31 AND avgFREQID <= 34) AND COUNT(att.PERF_ADA) >= 2) OR ((avgFREQID >= 13 AND avgFREQID <= 18) AND COUNT(att.PERF_ADA) >= 3) OR ((avgFREQID >= 47 AND avgFREQID <= 57) AND COUNT(att.PERF_ADA) >= 6),(sumSO - sumNED - sumMD)/(sumSO - sumNED),Null) AS MY_ADA,
AVG(att.CONFIG_ID) AS MY_CONFIG_ID
FROM dbo_RPT_PERFORMANCE_LEVEL_ATT AS att
WHERE INTERVAL NOT LIKE 'Attendance PrYr' AND PERF_ADA IS NOT NULL AND PERF_ADA >= 0
GROUP BY STUDENT_ID)
AS attCumul LEFT JOIN dbo_ATTENDANCE_CONFIG_BENCHMARKS AS attConfig
ON (attCumul.MY_CONFIG_ID = attConfig.CONFIG_ID AND attCumul.MY_ADA >= attConfig.MIN_VALUE AND attCumul.MY_ADA <= attConfig.MAX_VALUE))
AS MY_PROXY_ATTCUMUL ON (prepost.STUDENT_ID = MY_PROXY_ATTCUMUL.STUDENT_ID))
ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = dbo_RPT_STUDENT_MAIN.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 1) WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;