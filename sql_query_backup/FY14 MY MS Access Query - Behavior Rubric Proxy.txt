-- Restructure all behavior rubric data, then select latest administration, then merge to prepost rubric data table.
-- NEED TO CHECK THESE QUERIES ONCE SOME DATA HAS BEEN SUBMITTED.

-- QUERY SYNTAX (Restructure data file):

SELECT behrub.STUDENT_ID, behrub.INTERVAL,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Management',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_MNG_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Social Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SCL_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_REL_SKL_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_RES_DCN_MAK_PERF_VALUE,
IIf((PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL),(PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE)/5,NULL) AS PROXY_AVG_SCORE
FROM dbo_RPT_PERFORMANCE_LEVEL AS behrub
WHERE ((behrub.SKILL_DESCRIPTION LIKE 'Self Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Self Management' OR behrub.SKILL_DESCRIPTION LIKE 'Social Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills' OR behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making') AND (behrub.Tag IS NULL))
GROUP BY behrub.STUDENT_ID, behrub.INTERVAL;

-- QUERY SYNTAX (Create proxy data point file):

SELECT behrub1.*
FROM
(*****ABOVE_QUERY*****)
AS behrub1 LEFT JOIN
(*****ABOVE_QUERY*****)
AS behrub2 ON (behrub1.STUDENT_ID = behrub2.STUDENT_ID AND behrub1.INTERVAL < behrub2.INTERVAL)
WHERE behrub2.STUDENT_ID IS NULL;

-- QUERY SYNTAX (Merge and concatenate -- BASED ON ABOVE QUERIES):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, MY_PROXY_BEHRUB.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_INTERVAL,MY_PROXY_BEHRUB.INTERVAL) AS MY_INTERVAL,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SLF_AWR_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE) AS MY_SLF_AWR_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SLF_MNG_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE) AS MY_SLF_MNG_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SCL_AWR_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE) AS MY_SCL_AWR_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_REL_SKL_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE) AS MY_REL_SKL_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_RES_DCN_MAK_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE) AS MY_RES_DCN_MAK_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.AVG_POST_SCORE,MY_PROXY_BEHRUB.PROXY_AVG_SCORE) AS MY_AVG_SCORE,
IIf(prepost.AVG_PRE_SCORE IS NOT NULL AND MY_AVG_SCORE IS NOT NULL,MY_AVG_SCORE - prepost.AVG_PRE_SCORE,NULL) AS MY_AVE_SCORE_CHANGE,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.ENROLLED_DAYS >= 56,1,IIf(prepost.ENROLLED_DAYS < 56,0,NULL)) AS MY_MET_56_DAYS,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (dbo_EVAL_BEH_RUBRIC AS prepost LEFT JOIN
(*****ABOVE_QUERY*****)
AS MY_PROXY_BEHRUB ON (prepost.STUDENT_ID = MY_PROXY_BEHRUB.STUDENT_ID))
ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = dbo_RPT_STUDENT_MAIN.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 2)
WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;

-- QUERY SYNTAX (Merge and concatenate -- SINGLE QUERY VERSION):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, MY_PROXY_BEHRUB.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_INTERVAL,MY_PROXY_BEHRUB.INTERVAL) AS MY_INTERVAL,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SLF_AWR_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SLF_AWR_PERF_VALUE) AS MY_SLF_AWR_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SLF_MNG_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SLF_MNG_PERF_VALUE) AS MY_SLF_MNG_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_SCL_AWR_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_SCL_AWR_PERF_VALUE) AS MY_SCL_AWR_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_REL_SKL_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_REL_SKL_PERF_VALUE) AS MY_REL_SKL_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.POST_RES_DCN_MAK_PERF_VALUE,MY_PROXY_BEHRUB.PROXY_RES_DCN_MAK_PERF_VALUE) AS MY_RES_DCN_MAK_PERF_VALUE,
IIf(prepost.POST_INTERVAL IS NOT NULL,prepost.AVG_POST_SCORE,MY_PROXY_BEHRUB.PROXY_AVG_SCORE) AS MY_AVG_SCORE,
IIf(prepost.AVG_PRE_SCORE IS NOT NULL AND MY_AVG_SCORE IS NOT NULL,MY_AVG_SCORE - prepost.AVG_PRE_SCORE,NULL) AS MY_AVE_SCORE_CHANGE,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.ENROLLED_DAYS >= 56,1,IIf(prepost.ENROLLED_DAYS < 56,0,NULL)) AS MY_MET_56_DAYS,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (dbo_EVAL_BEH_RUBRIC AS prepost LEFT JOIN
(SELECT behrub1.*
FROM
(SELECT behrub.STUDENT_ID, behrub.INTERVAL,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Management',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_MNG_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Social Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SCL_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_REL_SKL_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_RES_DCN_MAK_PERF_VALUE,
IIf((PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL),(PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE)/5,NULL) AS PROXY_AVG_SCORE
FROM dbo_RPT_PERFORMANCE_LEVEL AS behrub
WHERE ((behrub.SKILL_DESCRIPTION LIKE 'Self Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Self Management' OR behrub.SKILL_DESCRIPTION LIKE 'Social Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills' OR behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making') AND (behrub.Tag IS NULL))
GROUP BY behrub.STUDENT_ID, behrub.INTERVAL)
AS behrub1 LEFT JOIN
(SELECT behrub.STUDENT_ID, behrub.INTERVAL,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Self Management',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SLF_MNG_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Social Awareness',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_SCL_AWR_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_REL_SKL_PERF_VALUE,
AVG(IIf(behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making',behrub.PERFORMANCE_VALUE_NUMERIC,Null)) AS PROXY_RES_DCN_MAK_PERF_VALUE,
IIf((PROXY_SLF_AWR_PERF_VALUE IS NOT NULL AND PROXY_SLF_MNG_PERF_VALUE IS NOT NULL AND PROXY_SCL_AWR_PERF_VALUE IS NOT NULL AND PROXY_REL_SKL_PERF_VALUE IS NOT NULL AND PROXY_RES_DCN_MAK_PERF_VALUE IS NOT NULL),(PROXY_SLF_AWR_PERF_VALUE + PROXY_SLF_MNG_PERF_VALUE + PROXY_SCL_AWR_PERF_VALUE + PROXY_REL_SKL_PERF_VALUE + PROXY_RES_DCN_MAK_PERF_VALUE)/5,NULL) AS PROXY_AVG_SCORE
FROM dbo_RPT_PERFORMANCE_LEVEL AS behrub
WHERE ((behrub.SKILL_DESCRIPTION LIKE 'Self Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Self Management' OR behrub.SKILL_DESCRIPTION LIKE 'Social Awareness' OR behrub.SKILL_DESCRIPTION LIKE 'Relationship Skills' OR behrub.SKILL_DESCRIPTION LIKE 'Responsible Decision Making') AND (behrub.Tag IS NULL))
GROUP BY behrub.STUDENT_ID, behrub.INTERVAL)
AS behrub2 ON (behrub1.STUDENT_ID = behrub2.STUDENT_ID AND behrub1.INTERVAL < behrub2.INTERVAL)
WHERE behrub2.STUDENT_ID IS NULL)
AS MY_PROXY_BEHRUB ON (prepost.STUDENT_ID = MY_PROXY_BEHRUB.STUDENT_ID))
ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID))
ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = dbo_RPT_STUDENT_MAIN.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 2)
WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;