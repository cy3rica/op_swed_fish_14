-- Select latest non-pre/post math assessment and merge to pre/post math assessment data

-- QUERY SYNTAX (Select latest math assessment, excluding pre/post tagged data points):

SELECT allMTH1.*
FROM dbo_RPT_PERFORMANCE_LEVEL AS allMTH1 LEFT JOIN dbo_RPT_PERFORMANCE_LEVEL AS allMTH2
ON (allMTH1.STUDENT_ID = allMTH2.STUDENT_ID AND allMTH1.INDICATOR_DESC = allMTH2.INDICATOR_DESC AND allMTH1.PERF_DATE < allMTH2.PERF_DATE AND allMTH1.CONFIG_NAME LIKE 'Math Assessment*' AND allMTH1.Tag IS NULL)
WHERE allMTH2.STUDENT_ID IS NULL;

-- QUERY SYNTAX (Merge to pre/post math assessment data -- BASED ON ABOVE QUERY):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, MY_PROXY_MTHAssess.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.PERF_DATE,prepost.POST_DATE) AS MY_PERF_DATE,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SKILL_DESCRIPTION,prepost.POST_DESC) AS MY_DESC,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC,prepost.POST_VALUE_NUM) AS MY_VALUE_NUM,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SCALE_LOCAL,prepost.POST_TRACK) AS MY_TRACK,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SCALE_EVAL,prepost.POST_TRACK_EVAL) AS MY_TRACK_EVAL,
IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM < MY_VALUE_NUM,'Increase',IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM = MY_VALUE_NUM,'No Change',IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM > MY_VALUE_NUM,'Decrease','Insufficient Data'))) AS MY_RAWCHANGE_DEGREE,
IIf((prepost.PRE_TRACK IS NOT NULL AND MY_TRACK IS NOT NULL),prepost.PRE_TRACK & ' to ' & MY_TRACK,'Insufficient Data') AS MY_PERFORMANCECHANGE_LOCAL,
IIf((prepost.PRE_TRACK_EVAL IS NOT NULL AND MY_TRACK_EVAL IS NOT NULL),prepost.PRE_TRACK_EVAL & ' to ' & MY_TRACK_EVAL,'Insufficient Data') AS MY_PERFORMANCECHANGE_NORMALIZED,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.TTL_TIME >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,1,IIf(prepost.TTL_TIME < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,0,NULL)) AS MY_MET_Q3_DOSAGE,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (dbo_EVAL_ASSESSMENT AS prepost LEFT JOIN
(*****ABOVE_QUERY*****)
AS MY_PROXY_MTHAssess ON (prepost.STUDENT_ID = MY_PROXY_MTHAssess.STUDENT_ID AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS')) ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 5)
WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;

-- QUERY SYNTAX (Merge to pre/post math assessment data -- SINGLE QUERY VERSION):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, MY_PROXY_MTHAssess.*, dbo_RPT_SCHOOL_GRADE.*,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.PERF_DATE,prepost.POST_DATE) AS MY_PERF_DATE,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SKILL_DESCRIPTION,prepost.POST_DESC) AS MY_DESC,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.PERFORMANCE_VALUE_NUMERIC,prepost.POST_VALUE_NUM) AS MY_VALUE_NUM,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SCALE_LOCAL,prepost.POST_TRACK) AS MY_TRACK,
IIf(prepost.POST_DATE IS NULL AND prepost.PRE_DATE < MY_PROXY_MTHAssess.PERF_DATE AND prepost.PRE_DESC LIKE MY_PROXY_MTHAssess.SKILL_DESCRIPTION,MY_PROXY_MTHAssess.SCALE_EVAL,prepost.POST_TRACK_EVAL) AS MY_TRACK_EVAL,
IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM < MY_VALUE_NUM,'Increase',IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM = MY_VALUE_NUM,'No Change',IIf((prepost.PRE_VALUE_NUM IS NOT NULL AND MY_VALUE_NUM IS NOT NULL) AND prepost.PRE_VALUE_NUM > MY_VALUE_NUM,'Decrease','Insufficient Data'))) AS MY_RAWCHANGE_DEGREE,
IIf((prepost.PRE_TRACK IS NOT NULL AND MY_TRACK IS NOT NULL),prepost.PRE_TRACK & ' to ' & MY_TRACK,'Insufficient Data') AS MY_PERFORMANCECHANGE_LOCAL,
IIf((prepost.PRE_TRACK_EVAL IS NOT NULL AND MY_TRACK_EVAL IS NOT NULL),prepost.PRE_TRACK_EVAL & ' to ' & MY_TRACK_EVAL,'Insufficient Data') AS MY_PERFORMANCECHANGE_NORMALIZED,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.TTL_TIME >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,1,IIf(prepost.TTL_TIME < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,0,NULL)) AS MY_MET_Q3_DOSAGE,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (dbo_EVAL_ASSESSMENT AS prepost LEFT JOIN
(SELECT allMTH1.*
FROM dbo_RPT_PERFORMANCE_LEVEL AS allMTH1 LEFT JOIN dbo_RPT_PERFORMANCE_LEVEL AS allMTH2
ON (allMTH1.STUDENT_ID = allMTH2.STUDENT_ID AND allMTH1.INDICATOR_DESC = allMTH2.INDICATOR_DESC AND allMTH1.PERF_DATE < allMTH2.PERF_DATE AND allMTH1.CONFIG_NAME LIKE 'Math Assessment*' AND allMTH1.Tag IS NULL)
WHERE allMTH2.STUDENT_ID IS NULL)
AS MY_PROXY_MTHAssess ON (prepost.STUDENT_ID = MY_PROXY_MTHAssess.STUDENT_ID AND prepost.ASSESSMENT_TYPE LIKE 'MATH_ASSESS')) ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 5)
WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;