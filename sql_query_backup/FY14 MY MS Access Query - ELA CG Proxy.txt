-- Select latest non-pre/post ELA CG and merge to pre/post ELA CG Data.

-- QUERY SYNTAX (Select latest ELA CG, excluding pre/post tagged data points):

SELECT allELA1.* FROM dbo_RPT_PERFORMANCE_LEVEL AS allELA1 LEFT JOIN dbo_RPT_PERFORMANCE_LEVEL AS allELA2 ON (allELA1.STUDENT_ID = allELA2.STUDENT_ID AND allELA1.INDICATOR_DESC = allELA2.INDICATOR_DESC AND allELA1.FREQ_SORT < allELA2.FREQ_SORT AND allELA1.SKILL_DESCRIPTION LIKE 'ELA Course Grade' AND allELA1.Tag IS NULL) WHERE allELA2.STUDENT_ID IS NULL;

-- QUERY SYNTAX (Merge to pre/post ELA CG data -- BASED ON ABOVE QUERY):

SELECT dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME, dbo_RPT_STUDENT_MAIN.GRADE_ID, dbo_RPT_STUDENT_MAIN.DIPLOMAS_NOW_SCHOOL, prepost.*, MY_PROXY_ELA_CG.*,dbo_RPT_SCHOOL_GRADE.*,
IIf(prepost.POST_ELA_FREQ IS NULL AND (prepost.PRE_ELA_FREQ < MY_PROXY_ELA_CG.INTERVAL OR prepost.PRE_ELA_FREQ LIKE 'ELA/Literacy PrYr/Cumulative'),MY_PROXY_ELA_CG.INTERVAL,prepost.POST_ELA_FREQ) AS MY_ELA_FREQ,
IIf(prepost.POST_ELA_FREQ IS NULL AND (prepost.PRE_ELA_FREQ < MY_PROXY_ELA_CG.INTERVAL OR prepost.PRE_ELA_FREQ LIKE 'ELA/Literacy PrYr/Cumulative'),MY_PROXY_ELA_CG.SCALE_LOCAL,prepost.POST_ELA_TRACK) AS MY_ELA_TRACK,
IIf(prepost.POST_ELA_FREQ IS NULL AND (prepost.PRE_ELA_FREQ < MY_PROXY_ELA_CG.INTERVAL OR prepost.PRE_ELA_FREQ LIKE 'ELA/Literacy PrYr/Cumulative'),MY_PROXY_ELA_CG.CG_LETTER_VIEW,prepost.POST_LETTER_VIEW) AS MY_LETTER_VIEW,
IIf(prepost.POST_ELA_FREQ IS NULL AND (prepost.PRE_ELA_FREQ < MY_PROXY_ELA_CG.INTERVAL OR prepost.PRE_ELA_FREQ LIKE 'ELA/Literacy PrYr/Cumulative'),MY_PROXY_ELA_CG.CG_LETTER_VIEW_ALL,prepost.POST_CG_LETTER_SCALE_ALL) AS MY_CG_LETTER_SCALE_ALL,
IIf(prepost.PRE_LETTER_VIEW IS NOT NULL AND MY_LETTER_VIEW IS NOT NULL,prepost.PRE_LETTER_VIEW & ' to ' & MY_LETTER_VIEW,NULL) AS MY_LETTERGRADE_CHANGE_ACTUAL,
IIf(prepost.PRE_ELA_TRACK IS NOT NULL AND MY_ELA_TRACK IS NOT NULL,[prepost].[PRE_ELA_TRACK] & " to " & MY_ELA_TRACK,NULL) AS MY_PERF_CHANGE,
IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 21,-1,IIf(dbo_RPT_STUDENT_MAIN.GRADE_ID = 22,0,dbo_RPT_STUDENT_MAIN.GRADE_ID)) AS GRADE_ID_RECODE,
IIf(((dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2848 Or dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 2988) And dbo_RPT_STUDENT_MAIN.GRADE_ID < 9) Or (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = 3010 And dbo_RPT_STUDENT_MAIN.GRADE_ID > 9),'0',DIPLOMAS_NOW_SCHOOL) AS DN_SCHOOL_BY_GRADE,
IIf(prepost.TTL_TIME >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,1,IIf(prepost.TTL_TIME < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL2,0,NULL)) AS MY_MET_Q3_DOSAGE,
IIf(GRADE_ID_RECODE >= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 AND GRADE_ID_RECODE <= dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,1,IIf(GRADE_ID_RECODE < dbo_RPT_SCHOOL_GRADE.B_RULE_VAL3 OR GRADE_ID_RECODE > dbo_RPT_SCHOOL_GRADE.B_RULE_VAL4,0,NULL)) AS MY_IN_IOG_GRADE_RANGE
FROM dbo_RPT_SCHOOL_GRADE INNER JOIN (dbo_RPT_STUDENT_MAIN INNER JOIN (dbo_EVAL_ELA AS prepost LEFT JOIN
(*****ABOVE_QUERY*****)
AS MY_PROXY_ELA_CG ON (prepost.STUDENT_ID = MY_PROXY_ELA_CG.STUDENT_ID)) ON (dbo_RPT_STUDENT_MAIN.STUDENT_ID = prepost.STUDENT_ID)) ON (dbo_RPT_SCHOOL_GRADE.SCHOOL_ID = prepost.SCHOOL_ID AND dbo_RPT_SCHOOL_GRADE.INDICATOR_ID = 3) WHERE dbo_RPT_SCHOOL_GRADE.GRADE_ID = dbo_RPT_STUDENT_MAIN.GRADE_ID;

-- QUERY SYNTAX (Can't seem to merge in decrease/increase variable in based on calculated field, so merging in increase/decrease variable here)

SELECT prepost2.*, letterchange.LetterGradeChange_general AS MY_Change
FROM
(*****ABOVE_QUERY*****)
AS prepost2 LEFT JOIN dbo_RPT_LETTER_CHANGE_DEGREE AS letterchange
ON (prepost2.MY_LETTERGRADE_CHANGE_ACTUAL LIKE letterchange.LetterGrade_Change_Actual)
ORDER BY dbo_RPT_STUDENT_MAIN.SITE_NAME, dbo_RPT_STUDENT_MAIN.SCHOOL_NAME,dbo_RPT_STUDENT_MAIN.GRADE_ID,prepost.STUDENT_ID;

-- QUERY SYNTAX (Merge letter grade change variable to pre/post ELA CG data -- SINGLE QUERY VERSION):

***** Not using a single query version here - too complex for now. *****